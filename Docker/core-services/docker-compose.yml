networks:
  core_network:
    name: "core_network"
    ipam:
      config:
        - subnet: "172.30.0.0/23"
          ip_range: "172.30.0.0/23"
          gateway: "172.30.1.254"

services:
  traefik:
    restart: "always"
    image: "traefik:v2.8.5"
    container_name: "traefik.docker.localhost"
    networks:
      core_network:
        ipv4_address: "172.30.0.1"
    volumes:
      - "$PWD/traefik:/etc/traefik:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    ports:
      - "8082:8082/tcp"
      - "9092:9092/tcp"

  coredns:
    restart: "always"
    image: "coredns/coredns:1.10.0"
    container_name: "coredns.docker.localhost"
    command:
      - "-conf=/etc/coredns/Corefile"
    volumes:
      - "$PWD/coredns:/etc/coredns:ro"
    networks:
      core_network:
        ipv4_address: "172.30.0.2"
    expose:
      - "9153:9153/tcp"
      - "5300:5300/udp"

  node-exporter:
    restart: "always"
    image: "prom/node-exporter:v1.3.1"
    container_name: "node-exporter.docker.localhost"
    command:
      - "--path.rootfs=/rootfs"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - "/:/rootfs:ro"
    networks:
      core_network:
        ipv4_address: "172.30.0.3"
    expose:
      - "9100:9100/tcp"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.node-exporter.service=node-exporter"
      - "traefik.http.routers.node-exporter.rule=Host(`node-exporter.docker.localhost`)"
      - "traefik.http.services.node-exporter.loadbalancer.server.port=9100"

  # watchtower:
  #   restart: "always"
  #   image: "containrrr/watchtower:1.4.0"
  #   container_name: "watchtower.docker.localhost"
  #   command:
  #     - "--interval=3600"
  #   volumes:
  #     - "/var/run/docker.sock:/var/run/docker.sock:ro"
  #   networks:
  #     core_network:
  #       ipv4_address: "172.30.0.4"
