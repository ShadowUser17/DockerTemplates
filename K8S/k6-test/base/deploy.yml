apiVersion: "batch/v1"
kind: "Job"
metadata:
  namespace: "testing"
  name: "k6-tests"
spec:
  backoffLimit: 3
  parallelism: 1
  completions: 1
  template:
    spec:
      restartPolicy: "Never"
      serviceAccount: "k6-sa"
      volumes:
        - name: "tmp"
          emptyDir: {}
        - name: "tests"
          configMap:
            name: "tests"
      containers:
        - name: "k6"
          image: "grafana/k6:latest"
          imagePullPolicy: "IfNotPresent"
          command: ["/usr/bin/k6"]
          args: ["run", "./main.js"]
          volumeMounts:
            - name: "tmp"
              mountPath: "/tmp"
            - name: "tests"
              mountPath: "/home/k6"
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
          resources:
            requests:
              cpu: "50m"
              memory: "160Mi"
            limits:
              cpu: "100m"
              memory: "250Mi"
