apiVersion: "v1"
kind: "ConfigMap"
metadata:
  namespace: "monitoring"
  name: "blackbox-config"

data:
  config.yml: |-
    modules:
      http_2xx:
        prober: "http"

      http_post_2xx:
        prober: "http"
        http:
          method: "POST"

      ssl_test:
        prober: "tcp"
        tcp:
          tls: true

      tcp_connect:
        prober: "tcp"

      icmp_ping:
        prober: "icmp"

---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  namespace: "monitoring"
  name: "blackbox-deploy"
  labels:
    app: "blackbox"

spec:
  replicas: 1
  selector:
    matchLabels:
      app: "blackbox"
  template:
    metadata:
      labels:
        app: "blackbox"
    spec:
      volumes:
        - name: "blackbox-config"
          configMap:
            name: "blackbox-config"

      containers:
        - name: "blackbox-exporter"
          image: "prom/blackbox-exporter:v0.22.0"
          ports:
            - containerPort: 9115
          volumeMounts:
            - name: "blackbox-config"
              mountPath: "/etc/blackbox_exporter"

---
apiVersion: "v1"
kind: "Service"
metadata:
  namespace: "monitoring"
  name: "blackbox"

spec:
  selector:
    app: "blackbox"
  ports:
    - name: "http"
      protocol: "TCP"
      port: 9115
      targetPort: 9115
