apiVersion: "apps/v1"
kind: "StatefulSet"
metadata:
  name: "thanos-receive-ingestor"
spec:
  minReadySeconds: 0
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: "thanos-receive"
  serviceName: "thanos-receive-ingestor"
  template:
    metadata:
      labels:
        app.kubernetes.io/name: "thanos-receive"
    spec:
      terminationGracePeriodSeconds: 900
      serviceAccountName: "thanos-receive-ingestor"
      securityContext:
        runAsUser: 65534
        fsGroup: 65534
      volumes:
        - name: "hashring-config"
          configMap:
            name: "hashring-config"
      containers:
        - name: "thanos-receive"
          image: "thanosio/thanos:latest"
          imagePullPolicy: "IfNotPresent"
          args:
            - "receive"
            - "--log.level=info"
            - "--log.format=logfmt"
            - "--grpc-address=0.0.0.0:10901"
            - "--http-address=0.0.0.0:10902"
            - "--remote-write.address=0.0.0.0:19291"
            - "--receive.replication-factor=1"
            - "--tsdb.path=/var/thanos/receive"
            - "--tsdb.retention=15d"
            - "--receive.local-endpoint=thanos-receive-ingestor.testing.svc:10901"
            - "--receive.hashrings-file=/var/lib/thanos-receive/hashrings.json"
          env:
            - name: "NAME"
              valueFrom:
                fieldRef:
                  fieldPath: "metadata.name"
            - name: "NAMESPACE"
              valueFrom:
                fieldRef:
                  fieldPath: "metadata.namespace"
            - name: "HOST_IP_ADDRESS"
              valueFrom:
                fieldRef:
                  fieldPath: "status.hostIP"
          volumeMounts:
            - name: "data"
              mountPath: "/var/thanos/receive"
            - name: "hashring-config"
              mountPath: "/var/lib/thanos-receive"
          ports:
            - containerPort: 10901
              name: "grpc"
            - containerPort: 10902
              name: "http"
            - containerPort: 19291
              name: "remote-write"
          livenessProbe:
            failureThreshold: 8
            periodSeconds: 30
            httpGet:
              path: "/-/healthy"
              port: 10902
              scheme: "HTTP"
          readinessProbe:
            failureThreshold: 20
            periodSeconds: 5
            httpGet:
              path: /-/ready
              port: 10902
              scheme: HTTP

  volumeClaimTemplates:
    - metadata:
        name: "data"
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "local-path"
        resources:
          requests:
            storage: "6Gi"
