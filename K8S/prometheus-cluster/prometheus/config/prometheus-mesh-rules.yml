groups:
  - name: "Kubernetes istio rules"
    rules:
      - alert: "Istio Pilot High Total Request Rate"
        expr: 'sum(rate(pilot_xds_push_errors[1m])) / sum(rate(pilot_xds_pushes[1m])) * 100 > 5'
        for: "2m"
        labels:
          severity: "warning"
        annotations:
          summary: "Istio Pilot high total request rate (instance {{ $labels.instance }})"
          description: "Number of Istio Pilot push errors is too high (> 5%). Envoy sidecars might have outdated configuration.\nValue: {{ $value }}\nLabels: {{ $labels }}"

      - alert: "Istio High Total Request Rate"
        expr: 'sum(rate(istio_requests_total{reporter="destination"}[5m])) > 1000'
        for: "2m"
        labels:
          severity: "warning"
        annotations:
          summary: "Istio high total request rate (instance {{ $labels.instance }})"
          description: "Global request rate in the service mesh is unusually high.\nValue: {{ $value }}\nLabels: {{ $labels }}"

      - alert: "Istio Low Total Request Rate"
        expr: 'sum(rate(istio_requests_total{reporter="destination"}[5m])) < 100'
        for: "2m"
        labels:
          severity: "warning"
        annotations:
          summary: "Istio low total request rate (instance {{ $labels.instance }})"
          description: "Global request rate in the service mesh is unusually low.\nValue: {{ $value }}\nLabels: {{ $labels }}"

      - alert: "Istio High 4XX Error Rate"
        expr: 'sum(rate(istio_requests_total{reporter="destination", response_code=~"4.*"}[5m])) / sum(rate(istio_requests_total{reporter="destination"}[5m])) * 100 > 5'
        for: "2m"
        labels:
          severity: "warning"
        annotations:
          summary: "Istio high 4xx error rate (instance {{ $labels.instance }})"
          description: "High percentage of HTTP 5xx responses in Istio (> 5%).\nValue: {{ $value }}\nLabels: {{ $labels }}"

      - alert: "Istio High 5XX Error Rate"
        expr: 'sum(rate(istio_requests_total{reporter="destination", response_code=~"5.*"}[5m])) / sum(rate(istio_requests_total{reporter="destination"}[5m])) * 100 > 5'
        for: "2m"
        labels:
          severity: "warning"
        annotations:
          summary: "Istio high 5xx error rate (instance {{ $labels.instance }})"
          description: "High percentage of HTTP 5xx responses in Istio (> 5%).\nValue: {{ $value }}\nLabels: {{ $labels }}"

      - alert: "Istio High Request Latency"
        expr: 'rate(istio_request_duration_milliseconds_sum{reporter="destination"}[1m]) / rate(istio_request_duration_milliseconds_count{reporter="destination"}[1m]) > 100'
        for: "2m"
        labels:
          severity: "warning"
        annotations:
          summary: "Istio high request latency (instance {{ $labels.instance }})"
          description: "Istio average requests execution is longer than 100ms.\nValue: {{ $value }}\nLabels: {{ $labels }}"

      - alert: "Istio Pilot Duplicate Entry"
        expr: 'sum(rate(pilot_duplicate_envoy_clusters{}[5m])) > 0'
        for: "2m"
        labels:
          severity: "critical"
        annotations:
          summary: "Istio Pilot Duplicate Entry (instance {{ $labels.instance }})"
          description: "Istio pilot duplicate entry error.\nValue: {{ $value }}\nLabels: {{ $labels }}"
